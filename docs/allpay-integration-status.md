# Allpay Integration Status

Дата обновления: 2026-02-11

## Готово

1. End-to-end оплата через Allpay работает.
- Создание заказа: `/api/checkout/create`.
- Переход на Allpay checkout.
- Возврат на `/payment/success` или `/payment/return`.

2. Callback и фиксация оплаты работают.
- Endpoint: `/api/payment/allpay-callback`.
- Подпись проверяется.
- Заказ переводится в `paid`.
- Повторная отправка письма по одному заказу не дублируется.

3. Email + билет работают в прод-потоке.
- Отправка через Resend после успешного callback.
- Письмо в 3 языках (RU/EN/HE).
- HTML + plain-text версии письма.
- PDF билет прикладывается к письму.

4. PDF билет доведен по верстке и RTL/LTR.
- Исправлен mixed bidi (иврит + латиница + цифры).
- Корректные название, дата/время, место, сумма.
- QR встроен.

5. Расписание автоматизировано через Supabase.
- Источник: таблица `public.schedule_events`.
- Управление: `/admin/schedule`.
- API выдачи расписания: `/api/schedule`.
- Поддержаны: лимит мест, sold-out, внешняя продажа билетов площадкой, Waze-ссылка.

6. Лимиты мест и sold-out работают.
- Поле `Кол-во мест` (capacity) опционально.
- Пусто = без лимита.
- При нуле остатка: `Sold out`.
- Checkout серверно блокирует перепродажу.

7. Правила отображения афиши внедрены.
- Если есть события текущего месяца: показываются только они (без лимита по количеству).
- Иначе: ближайшие будущие (до 7).
- Если будущих нет: последние прошедшие (до 7).

## Осталось

1. Deliverability (антиспам)
- Мониторинг DMARC-отчетов.
- При стабильной доставке: переход `none -> quarantine -> reject`.

2. Операционка
- Использовать `docs/operations-runbook.md` и `docs/ops-checklist-onepage.md` как рабочие документы.

3. Юридические тексты
- Поддерживать актуальность `/terms` и `/privacy` при изменениях политики/процессов.
