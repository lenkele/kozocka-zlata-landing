# Allpay Integration Status

Дата обновления: 2026-02-10

## Готово

1. End-to-end оплата через Allpay работает.
- Создание заказа: `/api/checkout/create`.
- Переход на Allpay checkout.
- Возврат на `/payment/success`.

2. Callback и фиксация оплаты работают.
- Endpoint: `/api/payment/allpay-callback`.
- Подпись проверяется.
- Заказ переводится в `paid`.
- Повторная отправка письма по одному заказу не дублируется.

3. Email + билет работают в прод-потоке.
- Отправка через Resend после успешного callback.
- Письмо в 3 языках (RU/EN/HE).
- Добавлены HTML + plain-text версии письма.
- PDF билет прикладывается к письму.

4. PDF билет доведен по верстке и RTL/LTR.
- Исправлен mixed bidi (иврит + латиница + цифры).
- Корректные название, дата/время, место, сумма.
- QR встроен.

5. Расписание автоматизировано.
- Источник: Google Sheets CSV.
- Обновление по кнопке: `/admin/schedule`.
- API sync: `/api/admin/schedule/sync`.
- API выдачи расписания: `/api/schedule`.
- Поддержаны human-friendly колонки таблицы.

6. Лимиты мест и sold-out работают.
- Поле `Кол-во мест` (capacity) опционально.
- Пусто = без лимита.
- При нуле остатка: `Sold out`.
- Checkout серверно блокирует перепродажу.

7. Правила отображения афиши внедрены.
- Если есть события текущего месяца: показываются только они (без лимита по количеству).
- Иначе: ближайшие будущие (до 7).
- Если будущих нет: последние прошедшие (до 7).

## Осталось

1. Deliverability (антиспам)
- Дожать DMARC-политику по этапам (`none -> quarantine -> reject`).
- Прогреть домен отправки.

2. Runbook/операционка
- Зафиксировать процедуры ротации ключей, redeploy, диагностики.
- Документ: `docs/operations-runbook.md`.

3. Юридические тексты
- Заменить заглушки `/terms` и `/privacy` на финальные документы.
