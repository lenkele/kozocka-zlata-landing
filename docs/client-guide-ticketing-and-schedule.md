# Интеграция с Allpay. Итоги

## 1. Процесс покупки билетов устроен так

### Что видит зритель
1. Зритель открывает страницу спектакля.
2. В блоке «Расписание» видит ближайшие события.
3. Для доступных событий нажимает кнопку «Купить билет».
4. Открывается форма заказа: имя, email, количество билетов, согласия.
5. После подтверждения зритель переходит на страницу оплаты Allpay.

### Что происходит после оплаты
1. Если оплата успешна:
- зритель попадает на страницу «Оплата прошла успешно»;
- на email автоматически приходит письмо с подтверждением;
- во вложении приходит электронный PDF-билет.

2. Если оплата неуспешна:
- зритель попадает на страницу «Ошибка оплаты»;
- может вернуться на сайт и попробовать снова.

### Важные правила
- Для закрытых показов покупка через сайт недоступна.
- Если места закончились, вместо кнопки показывается `Sold out`.
- Если продажу ведет площадка, кнопка ведет на внешнюю ссылку площадки.
- Если к событию добавлена ссылка на Waze, в письме и билете будет отдельная строка «Как добраться».

---

## 2. Процесс обновления расписания устроен так

Расписание теперь обновляется **напрямую через админку сайта** .

### Как добавить новое событие
1. Откройте страницу админки: `/admin/schedule`.
2. Войдите под логином и паролем администратора.
3. Заполните форму:
- спектакль;
- дата;
- время;
- место (RU/EN/HE);
- формат;
- язык;
- при необходимости — ссылка на Waze.

4. Если формат «Открытый показ», заполните блок «Продажа билетов»:
- вариант «Мы продаём (через сайт)»:
  - укажите стоимость;
  - укажите количество мест (опционально).
- вариант «Площадка продаёт»:
  - укажите внешнюю ссылку на покупку.

5. Нажмите «Сохранить».

### Как проверить результат
1. Ниже формы откройте список «Все события».
2. При необходимости используйте фильтры:
- по спектаклю;
- по периоду (текущий/прошлый/следующий месяц или все даты).
3. При необходимости скачайте текущую выборку кнопкой «Скачать CSV».
4. Откройте публичную страницу нужного спектакля и убедитесь, что событие отображается корректно.

---

## 3. Бесплатный билет (через админку)

### Где находится
1. Откройте страницу `/admin`.
2. Нажмите на аккордеон `Бесплатный билет` (по клику раскрывается форма).

### Как выдать бесплатный билет гостю
1. Выберите спектакль и событие.
2. Укажите имя и email гостя.
3. Укажите количество.
4. Нажмите `Выдать бесплатный билет`.

Что произойдет:
- создастся заказ со стоимостью `0`;
- на указанный email уйдет обычное письмо с билетами;
- тема письма единая: `Ваши билеты | Your tickets | הכרטיסים שלכם`.

### Как только скачать PDF (без отправки гостю)
1. В той же форме нажмите `Скачать PDF`.
2. Сайт сформирует и скачает билет локально, без отправки email.

---

## 4. Валидация билета на входе

### Как это работает
1. В каждом PDF-билете QR-код ведет на страницу проверки билета.
2. При открытии ссылки проверяется авторизация администратора.
3. Если админ авторизован:
- отображаются данные билета/заказа;
- доступна кнопка `Погасить билет`.
4. При нажатии `Погасить билет` в заказе фиксируется время погашения.
5. Повторное погашение того же билета не выполняется (билет уже отмечен как использованный).

### Если QR открыл не админ
1. Появляется окно авторизации.
2. При неуспешной авторизации пользователь перенаправляется на страницу соответствующего спектакля.

---

## Коротко: кто за что отвечает
- Администратор сайта: добавляет и обновляет события через `/admin/schedule`.
- Сайт: автоматически показывает расписание, управляет доступностью покупки и отправляет билеты после оплаты.
- Платежный сервис Allpay: принимает оплату.
- Почтовый сервис: отправляет подтверждение и билет на email покупателя.
